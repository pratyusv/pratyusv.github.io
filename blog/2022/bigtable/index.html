<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y5BVSQVXNK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Y5BVSQVXNK');
</script>        
    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Pratyush | BigTable</title>
    <meta name="author" content="Pratyush  Varshney" />
    <meta name="description" content="Wide column database" />
    <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website" />


    <!-- Bootstrap & MDB -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://gitcdn.link/repo/jwarby/jekyll-pygments-themes/master/github.css" />

    <!-- Styles -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://pratyusv.github.io/blog/2022/bigtable/">

    <!-- Dark Mode -->
    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
  </head>

  <!-- Body -->
  <body class="fixed-top-nav">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="https://pratyusv.github.io/">Pratyush</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">about</a>
              </li>
              
              <!-- Blog -->
              <!-- <li class="nav-item active">
                <a class="nav-link" href="/blog/">blog</a>
              </li> -->
              <!-- vitae -->
              <li class="nav-item ">
                <a class="nav-link" href="/assets/pdf/PratyushVarshney.pdf">vitae</a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/resources/">resources</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/tech/">tech</a>
              </li>

              <!-- Toogle theme mode -->
              <div class="toggle-container">
                <a id="light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </a>
              </div>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- Content -->
    <div class="container mt-5">
      <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">BigTable</h1>
    <p class="post-meta">January 4, 2022</p>
    <p class="post-tags">
      <a href="/blog/2022"> <i class="fas fa-calendar fa-sm"></i> 2022 </a>
        ·  
        <a href="/blog/category/Distributed%20Systems%20Components">
          <i class="fas fa-tag fa-sm"></i> Distributed Systems Components</a>  
          

    </p>
  </header>

  <article class="post-content">
    <p>It is a <strong>Consistent, Partial Fault Tolerance</strong> type database with strict consistent read/writes. It is suitable for large storage where each row is less than 10MB. It is used to store data for one of the types:</p>
<ol>
  <li>Time Series data: chronological data</li>
  <li>Constant stream of writes</li>
</ol>

<blockquote>
  <p>Use BigTable: Messaging App, Web Crawler, Analytics, Google Earth</p>
</blockquote>

<p><strong><code class="language-plaintext highlighter-rouge">Hbase</code></strong> and <strong><code class="language-plaintext highlighter-rouge">HyperTable</code></strong> databases are based on BigTable.</p>

<h3 id="general-conecpts">General Conecpts</h3>

<ol>
  <li>BigTable is a <strong>key/value</strong> store, not a relational database.</li>
  <li>Each table has <strong>only one index, the row key</strong>
</li>
  <li>Rows are sorted <strong>lexicographically by row key</strong>
</li>
  <li><strong>Column families are not stored in any specific order.</strong></li>
  <li>Columns are grouped by column family and sorted in lexicographic order within the column family.</li>
  <li>The intersection of a row and column can contain multiple timestamped cells</li>
</ol>

<hr>

<h3 id="data-model">Data Model</h3>

<p>An RDBMS database stores data as a two-dimensional entity, while big table stores data as a four-dimensional identity.</p>

<ol>
  <li>Row Key: uniquely identifies a row</li>
  <li>Column Family: Represents a group of columns</li>
  <li>Column qualifier: column name</li>
  <li>Timestamp</li>
</ol>

<h4 id="rows">Rows</h4>
<ol>
  <li>Rows keys are arbitrary strings with a size of 64KB.</li>
  <li>Every read or write to a row is atomic.</li>
  <li>Rows are maintained in lexicographic order by row key</li>
</ol>

<p>The BigTable retrieves data using:</p>
<ol>
  <li>Row key</li>
  <li>Row key prefix</li>
  <li>Range of rows defined by starting and ending row keys</li>
</ol>

<p>Store multiple delimited values in each row key. Because the best way to query Bigtable efficiently is by row key, it’s often useful to include multiple identifiers in the row key. Row key segments are usually separated by a delimiter, such as a colon, slash, or hash symbol. Row keys should be defined such that retrieving data does not require a full table scan. For eg:</p>

<div>
    <img src="/assets/img/bigTable/BigTableRowKey.png">
</div>

<p>This row key design lets you retrieve data with a single request for:</p>
<ul>
  <li>A device type</li>
  <li>A combination of device type and device ID</li>
</ul>

<div>
    <img src="/assets/img/bigTable/BigTableDataModel.png">
</div>

<div>
    <img src="/assets/img/bigTable/BigTableRow2.png">
</div>

<div>
    <img src="/assets/img/bigTable/BigTableRow.png">
</div>

<p>Here the row key is <code class="language-plaintext highlighter-rouge">com.CNN.www</code>. Content and anchor are column family. Anchor has two column qualifiers: cnnsi.com, my.look.ca. The content column has entries at multiple timestamps.</p>

<p>The data is indexed by</p>

<blockquote>
  <p>(row_key: string, column_name: string, timestamp: int64) \(\rightarrow\) cell contents (string)</p>
</blockquote>

<hr>
<h4 id="blocks">Blocks</h4>

<p>BigTable uses <strong><code class="language-plaintext highlighter-rouge">GFS</code></strong> to store Logs and data files. Internally the data is stored as <strong><code class="language-plaintext highlighter-rouge">SSTables</code></strong>. An <em>SSTabe</em> provides a persistent, ordered immutable map from key to values.</p>

<p>Internally each SSTable contains a sequence of blocks (64KB size). A <em>block index</em> stored at the end of the SSTable is used to locate the blocks. The <em>block index</em> is loaded into the memory when SSTable is opened.</p>

<p>To find a block: binary search is performed on the <em>block index</em> to locate the block offset. Then a single seek is performed, to read the block.</p>

<hr>

<h4 id="implementation">Implementation</h4>

<p>A single instance of BigTable is called <strong><code class="language-plaintext highlighter-rouge">Cluster</code></strong>. Each cluster can store multiple <strong><code class="language-plaintext highlighter-rouge">Tables</code></strong>. Each table is split into multiple <strong><code class="language-plaintext highlighter-rouge">Tablets</code></strong>.</p>

<ol>
  <li>Tablet store contiguous rows</li>
  <li>Each tablet is assigned to a <strong><code class="language-plaintext highlighter-rouge">Tablet Server</code></strong>
</li>
</ol>

<p>BigTable has three major components:</p>
<ol>
  <li>library that is linked to every client</li>
  <li>Single master server</li>
  <li>Many tablet servers: can be dynamically added or removed from the cluster</li>
</ol>

<p>Master</p>
<p>Master is responsible for assigning tablets to tablet servers, detecting the addition and expiration of tablet servers, balancing tablet-server load, etc. It also handles schema changes such as table and column family creations.</p>

<p><code class="language-plaintext highlighter-rouge">Client always does not have to move through the master, thereby the load on the master is low. Clients can directly communicate with the Tablet server.</code></p>

<p>Tablet Server</p>
<p>Each tablet server manages multiple tablets (10 to 10000). It handles read/write requests to the tablets that it has loaded and also splits tablets when they grow too large.</p>

<hr>
<h2 id="architecture">Architecture</h2>

<div>
    <img src="/assets/img/bigTable/BigTableArch.png">
</div>

<h4 id="tablet-location">Tablet Location</h4>

<p>Three-level-hierarchy analogous to the B+ tree is used to store tablet information.</p>

<div>
    <img src="/assets/img/bigTable/TabletLocation.png">
</div>

<p>A chubby file contains the location of the <code class="language-plaintext highlighter-rouge">root tablet</code>. The root tablet has a special <strong><code class="language-plaintext highlighter-rouge">METADATA</code></strong> table that stores the Tablet locations.  It stores the location of a tablet under a row key that is encoding of <em><code class="language-plaintext highlighter-rouge">tablet's table identifier and end row</code></em></p>

<pre><code class="language-JSON">METADATA:
    Key: table id + end row
    Value: tablet server location
</code></pre>
<ul>
  <li>Root Metadata tablet: This tablet is indivisible and stores the location of all the other metadata tablets.</li>
  <li>Other Metadata tablets: They store the location of user metadata tablets.</li>
</ul>

<p>The client caches the information about the tablet location. If the tablet location is unknown or changed, then it recursively moves up the tablet location hierarchy.</p>

<hr>

<h4 id="tablet-assignment">Tablet Assignment</h4>

<p>Each tablet is assigned to one tablet server.</p>

<p>Master keeps track of live tablet servers, and current assignment of tablets to tablet servers as well as unassigned tablets. BigTable uses <em><code class="language-plaintext highlighter-rouge">Chubby</code></em> to keep track of tablet servers.</p>

<ol>
  <li>When a tablet server starts, it creates and acquires an exclusive lock on, a uniquely-named file in the specific chubby directory.</li>
  <li>The master monitors this directory to keep track of the tablet servers.</li>
  <li>A tablet server stops serving the tablets if it loses its exclusive lock.</li>
  <li>A tablet server will try to re-acquire the lock as long as the file exists. If the file does not exist then the tablet server will kill itself</li>
  <li>Master is responsible for detecting when a tablet server is no longer serving its tablets, and for reassigning those tablets to other servers.
    <ul>
      <li>To achieve this, the master periodically asks the tablet server for the status of its lock.</li>
      <li>If the tablet server reports that it has lost its locks or the master is unable to reach the server, the Master attempts to acquire an exclusive lock on the server’s file. If the master can acquire the lock and Chubby is live, the Master can conclude that either the server is dead or the server is having trouble reaching the chubby.</li>
      <li>Master delete’s the server file and moves the associated tablets to unassigned.</li>
    </ul>
  </li>
</ol>

<p>To ensure that master and chubby are not vulnerable to networking issues, Master kills itself when the Chubby session expires. Cluster Management System restarts the master. On startup, master performs the following steps:</p>

<ol>
  <li>Master grabs unique <em>master</em> lock in Chubby, preventing the concurrent master installation</li>
  <li>Master scans the servers directory of Chubby to find live servers</li>
  <li>Master communicates with every live tablet server to discover what tablet are already assigned to each server.</li>
  <li>Master scans the METADATA table to learn the set of tablets. While scanning if it encounters any tablet not assigned to any tablet server, the master adds it to the list of unassigned.</li>
</ol>

<hr>

<h4 id="tablet-serving">Tablet Serving</h4>

<p>The persistent state of the table is stored in GFS. Updates are committed to a commit log that stores redo records. Of these updates, the recently committed ones are stored in memory in a sorted buffer called <code class="language-plaintext highlighter-rouge">memtable</code>; older updates are stored in <code class="language-plaintext highlighter-rouge">SSTables</code>.</p>

<div>
    <img src="/assets/img/bigTable/TabletStorage.png">
</div>

<p>Tablet recovery</p>

<ol>
  <li>To recover a tablet, the server reads its metadata from the METADATA table.</li>
  <li>This metadata contains the list of SSTables that comprise a tablet and a set of redo points, which are pointers into any commit logs that may contain data for the tablet.</li>
  <li>The server reads the indices of the SSTables into memory and reconstructs the memtable by applying all of the updates that have been committed since the redo points.</li>
</ol>

<hr>

<h4 id="write-request">Write Request</h4>
<ol>
  <li>The write request arriving at the tablet server is checked if it is well-formed and writer is authorized to write.</li>
  <li>The mutation is written to the commit log in GFS that stores the redo logs.</li>
  <li>Once the mutation is committed to the commit-log, its content is stored in a sorted memory called <code class="language-plaintext highlighter-rouge">MemTable</code>
</li>
  <li>After inserting into MemTable, ack is sent to the client.</li>
  <li>Periodically MemTables are flushed to SSTables, and SSTables are merged during compaction</li>
</ol>

<div>
    <img src="/assets/img/bigTable/BigTableWrite.png">
</div>

<h4 id="read-request">Read Request</h4>
<ol>
  <li>When a read request arrives at the tablet server, it is checked for well-formedness.</li>
  <li>A valid read request is executed on a merged sequence of SSTable and MemTable. Since both are lexicographically sorted the view can be created efficiently.</li>
</ol>

<hr>

<h4 id="reference">Reference</h4>
<ol>
  <li>Google
    <ul>
      <li><a href="https://cloud.google.com/bigtable/docs/schema-design#general-concepts" target="_blank" rel="noopener noreferrer">Schema Design</a></li>
      <li><a href="https://cloud.google.com/bigtable/docs/overview" target="_blank" rel="noopener noreferrer">Overview</a></li>
    </ul>
  </li>
  <li>HBase
    <ul>
      <li><a href="https://hbase.apache.org/book.html#schema" target="_blank" rel="noopener noreferrer">Book</a></li>
    </ul>
  </li>
</ol>

  </article>

  
  <div id="disqus_thread"></div>
  <script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://https-pratyusv-github-io.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" target="_blank" rel="noopener noreferrer">comments powered by Disqus.</a>
</noscript>
  <a href="http://disqus.com" class="dsq-brlink" target="_blank" rel="noopener noreferrer">comments powered by <span class="logo-disqus">Disqus</span></a>
  
</div>

    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        © Copyright 2024 Pratyush  Varshney. Powered by <a href="http://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>.

      </div>
    </footer>
  </body>

  <!-- jQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>

  <!-- Bootsrap & MDB scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  <!-- Mansory & imagesLoaded -->
  <script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
  <script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/mansory.js" type="text/javascript"></script>
  
  <!-- Medium Zoom JS -->
  <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
  <script src="/assets/js/zoom.js"></script><!-- Load Common JS -->
  <script src="/assets/js/common.js"></script>

  <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id="></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', '');
  </script>
</html>

