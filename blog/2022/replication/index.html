<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y5BVSQVXNK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Y5BVSQVXNK');
</script>        
    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Pratyush | Replication</title>
    <meta name="author" content="Pratyush  Varshney" />
    <meta name="description" content="Replication gives Availability" />
    <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website" />


    <!-- Bootstrap & MDB -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://gitcdn.link/repo/jwarby/jekyll-pygments-themes/master/github.css" />

    <!-- Styles -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://pratyusv.github.io/blog/2022/replication/">

    <!-- Dark Mode -->
    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
  </head>

  <!-- Body -->
  <body class="fixed-top-nav">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="https://pratyusv.github.io/">Pratyush</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">about</a>
              </li>
              
              <!-- Blog -->
              <!-- <li class="nav-item active">
                <a class="nav-link" href="/blog/">blog</a>
              </li> -->
              <!-- vitae -->
              <li class="nav-item ">
                <a class="nav-link" href="/assets/pdf/PratyushVarshney.pdf">vitae</a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/resources/">resources</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/tech/">tech</a>
              </li>

              <!-- Toogle theme mode -->
              <div class="toggle-container">
                <a id="light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </a>
              </div>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- Content -->
    <div class="container mt-5">
      <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Replication</h1>
    <p class="post-meta">January 11, 2022</p>
    <p class="post-tags">
      <a href="/blog/2022"> <i class="fas fa-calendar fa-sm"></i> 2022 </a>
        ·  
        <a href="/blog/category/Distributed%20Systems%20Components">
          <i class="fas fa-tag fa-sm"></i> Distributed Systems Components</a>  
          

    </p>
  </header>

  <article class="post-content">
    <p>Each node that stores a copy is called a <code class="language-plaintext highlighter-rouge">replica</code>. With multiple replicas, the challenge arises in how to ensure that all the data ends up on all replicas.</p>

<hr>

<h2 id="leaders-and-followers">Leaders and Followers</h2>
<ol>
  <li>One of the replicas is elected as <code class="language-plaintext highlighter-rouge">leader</code>. When clients want to write data they send their requests to <code class="language-plaintext highlighter-rouge">leader</code>, which firsts write the new data to its local storage.</li>
  <li>Other replicas as called <code class="language-plaintext highlighter-rouge">followers</code>. Whenever the leader writes new data to its local storage, it also sends the data change to all its followers as a part of a <code class="language-plaintext highlighter-rouge">replication log</code>. Each follower takes the log from the leader and updates its local copy of the data.</li>
  <li>Generally all the write requests are sent to users and read requests can be sent to any follower.</li>
</ol>

<p><strong>Asynchronous vs Synchronous Replication</strong></p>
<div>
    <img src="/assets/img/replication/synch.png">
</div>

<ol>
  <li>
<strong>Synchronous:</strong>
    <ul>
      <li>The leader responds to the client with successful write only if it has received ACK of writes from all the followers. In this way, it ensured that all the replicas contain the same data as the leader and any read request to any replica will always return the most up-to-date values.</li>
      <li>The problem with this approach is that, if a follower crashes or is disconnected due to network issues, the leader is kept waiting for the ACK to write.</li>
      <li>Receiving ACK from all the followers makes the writes slower.</li>
    </ul>
  </li>
  <li>
<strong>Asynchronous:</strong>
    <ul>
      <li>The leader responds to the client that the write is successful without waiting for followers for the ACK.</li>
      <li>Writes are quite fast</li>
      <li>If the leader fails and is not recoverable, any writes that have not yet been replicated by the followers are lost. Writes are not durable, even if it has been confirmed to the client.</li>
    </ul>
  </li>
</ol>

<h3 id="log-replication">Log Replication</h3>

<ul>
  <li>In the case of log-structured storage engines (SSTables), this log is the main place of storage. Logs are compacted and garbage-collected in the background from time to time.</li>
  <li>In the case of B-Tree, which overwrites individual disk blocks, every modification is first written into write-ahead-logs so that the index can be restored in case of a crash</li>
</ul>

<p>When the leader receives a write request it writes it to append-only logs for both SSTables and B-Tree. These logs are forwarded by the leader to replicas. The followers can then execute these logs to build the replica and keep it in sync with the leader.</p>

<hr>

<h2 id="leaderless-replication">Leaderless Replication</h2>

<p>In leaderless implementations, the client directly sends its write to several replicas, while in some cases to a coordinator node. However, unlike the leader, the coordinator node does not enforce a particular ordering of writes.</p>

<blockquote>
  <p>Cassandra, Dynamo are some of the databases that use leaderless replication</p>
</blockquote>

<hr>

<h3 id="readwrite-operations">Read/Write Operations</h3>

<p><strong>write</strong></p>

<p>The client can forward the write to multiple replicas in parallel. If it receives ACK from a few replicas, it can move on. For example,</p>
<ul>
  <li>if there are four replicas and clients sends a write request to all the replicas</li>
  <li>suppose the fourth replica goes down (rebooted/crashed/network disconnection)</li>
  <li>the client will receive the ACK from the three replicas</li>
  <li>it can assume that its write is successful even if it has not received the ACK from the fourth replica as the majority has responded with ACK.</li>
</ul>

<p><strong>read</strong></p>

<p>Similar to the write operation, the client can send the read request in parallel to multiple replicas.</p>
<ul>
  <li>the client must compare the values and timestamp received from all the replicas to determine which is the latest value</li>
</ul>

<hr>

<h3 id="read-repair">Read repair</h3>

<p>Two techniques used for read repair in Dynamo styled DBs</p>

<ol>
  <li>
<strong>Read Repair</strong>: When a client receives stale data from a node, it sends a write request to that node with the most up-to-date value.</li>
  <li>
<strong>Anti-entropy process</strong>:
    <ul>
      <li>a background process runs that constantly looks for differences in the data between nodes and copies any missing data from one node to another</li>
      <li>without an anti-entropy mechanism, values that are rarely read may be missing from nodes</li>
      <li>
<code class="language-plaintext highlighter-rouge">Merkel tree</code> are used for comparing nodes</li>
    </ul>
  </li>
</ol>

<p><strong>Merkel Trees</strong>
A Merkel tree is a tree in which a leaf is a <code class="language-plaintext highlighter-rouge">cryptographic hash</code> of a data block, and every non-leaf node is labeled with the cryptographic hash of the labels of its child.</p>

<div>
    <img src="/assets/img/replication/merkel_tree.png">
</div>

<hr>

<h3 id="quorums">Quorums</h3>

<p>If there are <code class="language-plaintext highlighter-rouge">N</code> nodes,</p>

<ul>
  <li>every write must be confirmed by <code class="language-plaintext highlighter-rouge">w</code> nodes to be considered successful</li>
  <li>every read must query <code class="language-plaintext highlighter-rouge">r</code> nodes</li>
</ul>

<p>such that</p>
<blockquote>
  <p><code class="language-plaintext highlighter-rouge">w + r &gt; N</code></p>
</blockquote>

<p>This ensures that the read is performed from at least one node that has seen the most write.</p>

<p>Generally, the read/write requests are sent to all the <code class="language-plaintext highlighter-rouge">N</code> nodes. The quorum parameters indicate how many ACKs should the client wait for to consider its read/write operation successful.</p>

<hr>

<h3 id="sloppy-quorum-and-hinted-handoff">Sloppy Quorum and Hinted Handoff</h3>

<p>When the data is partitioned each node is assigned a particular range for which it can read/write. This data is replicated across other nodes.</p>

<ul>
  <li>Suppose some of the nodes designated to store data <em>X</em> are down.</li>
  <li>The quorum for write is not reached. Instead of rejecting the write as unsuccessful to the client, the database can ask other nodes(not designated to store <em>X</em>) to store the data temporarily till the designated nodes come up.</li>
</ul>

<hr>

<h3 id="multi-datacenter-operations">Multi-datacenter Operations</h3>

<p>Leaderless replication is suitable for multi-datacenter operations.</p>

<ul>
  <li>the number of nodes <code class="language-plaintext highlighter-rouge">N</code> includes all the nodes in every data center</li>
  <li>each write from the client is sent to all the <code class="language-plaintext highlighter-rouge">N</code> nodes</li>
  <li>client only waits for the ACKs from the quorum of nodes in the local datacenter, so that the network delay and interruptions between datacenters do not affect to operation</li>
  <li>The higher-latency writes happens asynchronously in the background</li>
</ul>

<hr>

<h3 id="consistency-level">Consistency Level</h3>

<p>For every read request, read-repair is performed. It can be done across data centers as well</p>

<ul>
  <li>
<strong>ONE</strong> :
    <ul>
      <li>the data is returned to client from a single node.</li>
      <li>very fast but high probability of stale data</li>
    </ul>
  </li>
  <li>
<strong>QUORUM</strong>:
    <ul>
      <li>&gt; 51% replicas ack</li>
      <li>high consistency as there is atleast one single node that has seen the latest write</li>
    </ul>
  </li>
  <li>
<strong>LOCAL QUORUM</strong>:
    <ul>
      <li>&gt; 51% replicas ack in local Data Center</li>
    </ul>
  </li>
  <li>
<strong>LOCAL_ONE</strong>:
    <ul>
      <li>&gt; read repair only in local Data Center</li>
    </ul>
  </li>
  <li>
<strong>ALL</strong>:
    <ul>
      <li>Ack from all nodes</li>
    </ul>
  </li>
</ul>

<hr>
<h2 id="raft">Raft</h2>

<div>
    <img src="/assets/img/replication/raft.png">
</div>

<p>Raft is a replication protocol that works on the leader-follower principle.</p>
<ul>
  <li>Raft is included by every server as a library</li>
  <li>Every request sent by the client is forwarded to the raft</li>
  <li>raft writes that request into its log and parallelly forwards it to other followers</li>
  <li>Once Acks from the majority of the followers are received (including itself), leader ACKs to a client of a successful write</li>
  <li>The leader then executes the command to update the key-value store</li>
  <li>The logs are backed up on the disk. In case of a crash, these logs are used to reconstruct the node</li>
</ul>


  </article>

  
  <div id="disqus_thread"></div>
  <script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://https-pratyusv-github-io.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" target="_blank" rel="noopener noreferrer">comments powered by Disqus.</a>
</noscript>
  <a href="http://disqus.com" class="dsq-brlink" target="_blank" rel="noopener noreferrer">comments powered by <span class="logo-disqus">Disqus</span></a>
  
</div>

    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        © Copyright 2024 Pratyush  Varshney. Powered by <a href="http://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>.

      </div>
    </footer>
  </body>

  <!-- jQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>

  <!-- Bootsrap & MDB scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  <!-- Mansory & imagesLoaded -->
  <script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
  <script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/mansory.js" type="text/javascript"></script>
  
  <!-- Medium Zoom JS -->
  <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
  <script src="/assets/js/zoom.js"></script><!-- Load Common JS -->
  <script src="/assets/js/common.js"></script>

  <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id="></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', '');
  </script>
</html>

