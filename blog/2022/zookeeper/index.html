<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y5BVSQVXNK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Y5BVSQVXNK');
</script>        
    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Pratyush | Zookeeper</title>
    <meta name="author" content="Pratyush  Varshney" />
    <meta name="description" content="Coordination Service" />
    <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website" />


    <!-- Bootstrap & MDB -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://gitcdn.link/repo/jwarby/jekyll-pygments-themes/master/github.css" />

    <!-- Styles -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://pratyusv.github.io/blog/2022/zookeeper/">

    <!-- Dark Mode -->
    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
  </head>

  <!-- Body -->
  <body class="fixed-top-nav">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="https://pratyusv.github.io/">Pratyush</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">about</a>
              </li>
              
              <!-- Blog -->
              <!-- <li class="nav-item active">
                <a class="nav-link" href="/blog/">blog</a>
              </li> -->
              <!-- vitae -->
              <li class="nav-item ">
                <a class="nav-link" href="/assets/pdf/PratyushVarshney.pdf">vitae</a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/resources/">resources</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/tech/">tech</a>
              </li>

              <!-- Toogle theme mode -->
              <div class="toggle-container">
                <a id="light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </a>
              </div>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- Content -->
    <div class="container mt-5">
      <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Zookeeper</h1>
    <p class="post-meta">January 9, 2022</p>
    <p class="post-tags">
      <a href="/blog/2022"> <i class="fas fa-calendar fa-sm"></i> 2022 </a>
        ·  
        <a href="/blog/category/Distributed%20Systems%20Components">
          <i class="fas fa-tag fa-sm"></i> Distributed Systems Components</a>  
          

    </p>
  </header>

  <article class="post-content">
    <p>Zookeeper(ZK) is a coordination service. One of the basic form of coordianation is Configuration. ZK stores the configuration of a system and makes it highly available by replication.</p>

<p>Coordination</p>

<ul>
  <li>Group Membership</li>
  <li>Leader election</li>
  <li>Dynamic Configuration</li>
  <li>Status Monitoring</li>
  <li>Queuing</li>
</ul>

<p>Overview</p>

<ul>
  <li>It does not implement lock like structures as  Chubby but uses <em><code class="language-plaintext highlighter-rouge">wait free</code></em> data objects organized heirarichally as in file system.</li>
  <li>It is suited for read heavy systems. Reads are quite fast but write take some time to persist.</li>
  <li>It ensures <em><code class="language-plaintext highlighter-rouge">FIFO client ordering and Linearizable writes</code></em> but <em><code class="language-plaintext highlighter-rouge">reads are eventually consistant</code></em>
</li>
  <li>Under the hood ZK uses <em><code class="language-plaintext highlighter-rouge">Zab (Zookeeper Atomic Broadcast)</code></em> service</li>
  <li>Clients cache the current ZK leader, to prevent them probing ZK everytime</li>
  <li>Clients establish session when they connect to ZK service and obtain a session handle through which they issue requests</li>
</ul>

<hr>
<h2 id="data-model">Data Model</h2>

<p>ZK stores data in file format called znodes. They are heirarchal namespaces (like file system). Each znode has data and children. There are two types of znodes:</p>
<ol>
  <li>
    <p><strong>Ephemeral</strong>: znode deleted when creater fails or explicitly deleted.</p>

    <p>A typical use case for ephemeral nodes is when using ZooKeeper for discovery of hosts in the distributed system. Each server can then publish its IP address in an ephemeral node, and should a server loose connectivity with ZooKeeper and fail to reconnect within the session timeout, then its information is deleted.</p>
  </li>
  <li>
    <p><strong>Sequence</strong>: append a monotonically increasing counter</p>
  </li>
</ol>

<div>
    <img src="/assets/img/zk/zk_datamodel.png">
</div>

<hr>

<h2 id="zookeeper-apis">Zookeeper APIs</h2>

<p> Create, delete, exists znode </p>

<ol>
  <li>
<strong>create(path, data, flags)</strong>: Creates a znode with path name <em>path</em> and stores the <em>data[]</em> in it, and returns the name of new znode.<em>flags</em> indicate the type of node: <em>regular, ephermeral, sequential</em> flag.</li>
  <li>
<strong>delete(path, version)</strong>: Delete the znode if it is at the expected version</li>
  <li>
<strong>exists(path, watch)</strong>: Returns true is path exists else returns false. It enables client to keep a watch</li>
</ol>

<p> get, set data znode </p>

<ol>
  <li>
<strong>getData(path, watch)</strong>: returns the data and meta-data, such as version info associated with znode. Enables watch if path exists.</li>
  <li>
<strong>setData(path, data, version)</strong>: writes data[] to path if the znode with version exists</li>
</ol>

<p>  others </p>

<ol>
  <li>
<strong>getChildren(path, watch)</strong>: returns the set of names of the children of a znode.</li>
  <li>
<strong>syncpath(path)</strong>: wait for all the updates pending at the start of the operation to propogate to the server that the client is connected to.</li>
</ol>

<hr>

<h2 id="writes">Writes</h2>

<p>All the writes go through the leader. Every data object has a version number. When a write is successfull, the version number is increamented by 1.</p>

<p>Let’s write a program that increaments a counter in file whenever an incident occurs. The incident can occur at any client and should result in increament of counter.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> <span class="n">true</span><span class="p">:</span> 
    <span class="n">x</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="nf">getData</span><span class="p">(</span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">if </span><span class="p">(</span><span class="nf">setData</span><span class="p">(</span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">v</span><span class="p">)):</span>
        <span class="k">break</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here <strong>setData(“file”,x+1, v)</strong> will only set <em>file</em> to <em>x+1</em> if the version number matches <em>v</em>.</p>

<hr>
<h2 id="locks">Locks</h2>

<p>ZK can provide distributed locks.</p>
<ul>
  <li>The clients who want to aquire the lock attempt to create an ephemeral node, which gets deleted when the lock is released.</li>
  <li>The client is successful in aquring the lock if it is able to create the node.</li>
  <li>If the it fails, it means that some node has already created the node and acquired the lock. Then client then can put a watch on the node and wait for the notification of the node getting deleted. It can then retry again to acquire the lock.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">acquire</span><span class="p">():</span>
    <span class="k">while</span> <span class="n">true</span><span class="p">:</span>
        <span class="k">if</span> <span class="nf">create</span><span class="p">(</span><span class="sh">"</span><span class="s">lf</span><span class="sh">"</span><span class="p">,</span>  <span class="n">EPHEMERAL</span><span class="p">)</span>
            <span class="n">success</span>
        <span class="k">if</span> <span class="nf">exists</span><span class="p">(</span><span class="sh">"</span><span class="s">lf</span><span class="sh">"</span><span class="p">,</span> <span class="n">watch</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
            <span class="n">wait</span> <span class="k">for</span> <span class="n">notification</span>
    
    <span class="nf">release</span><span class="p">():</span>
        <span class="nf">delete</span><span class="p">(</span><span class="sh">"</span><span class="s">lf</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>When a client releases the lock, every other client will try to aquire the lock. If there a lot of clients waiting for the lock, it will trigger a huge traffic of <em>create</em> requests. This is called <em><code class="language-plaintext highlighter-rouge">Herd effect</code></em>. The complexity becomes \(O(n^2)\).</p>

<p>To overcome this problem, sequence in which clients requests can be used to grant the lock.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">While</span> <span class="n">true</span><span class="p">:</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nf">create</span><span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/lock-</span><span class="sh">'</span><span class="p">,</span> <span class="n">EPHEMERAL</span><span class="o">|</span><span class="n">SEQUENTIAL</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="nf">getChildren</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">false</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="n">lowest</span> <span class="n">znode</span> <span class="ow">in</span> <span class="n">C</span><span class="p">,</span> <span class="nb">exit</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">znode</span> <span class="ow">in</span> <span class="n">C</span> <span class="n">ordered</span> <span class="n">just</span> <span class="n">before</span> <span class="n">n</span>
    <span class="k">if</span> <span class="nf">exists</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">true</span><span class="p">)</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">watch</span> <span class="n">event</span>
        <span class="n">goto</span> <span class="mi">2</span>

<span class="nc">Unlock</span><span class="p">()</span>
    <span class="nf">delete</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</code></pre></div></div>

<hr>

<h2 id="configuration">configuration</h2>

<div>
    <img src="/assets/img/zk/zk_config.png">
</div>

<p><br></p>

<ul>
  <li>workers get configuration
    <ul>
      <li><strong>getData(“../config/settings”, true)</strong></li>
    </ul>
  </li>
  <li>Administrator changes setting
    <ul>
      <li><strong>setData(“../config/settings”, newConf, -1)</strong></li>
    </ul>
  </li>
  <li>Workers notified of change and get new settings
    <ul>
      <li><strong>getData(“../config/settings”, true)</strong></li>
    </ul>
  </li>
</ul>

<hr>

<h2 id="leader-election">leader election</h2>

<p>An easy way of doing leader election with ZooKeeper is to let every server publish its information in a zNode that is both <strong><code class="language-plaintext highlighter-rouge">sequential and ephemeral</code></strong>. Then, whichever server has the lowest sequential zNode is the leader. If the leader or any other server for that matter, goes offline, its session dies and its ephemeral node is removed, and all other servers can observe who is the new leader.</p>

<hr>

<h3 id="resources">Resources</h3>

<ol>
  <li><a href="https://www.youtube.com/watch?v=rXI9xiesUV8&amp;ab_channel=CNSwebcast" target="_blank" rel="noopener noreferrer">Benjamin Reed’s Talk</a></li>
  <li>
<a href="/assets/img/zk/notes.txt">MIT Notes</a>
    <ul>
      <li><a href="http://dsrg.pdos.csail.mit.edu/2013/07/11/zookeeper/" target="_blank" rel="noopener noreferrer">MIT Discussion</a></li>
    </ul>
  </li>
  <li>Apache Wiki: <a href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/Index" target="_blank" rel="noopener noreferrer">Link 1</a> <a href="https://zookeeper.apache.org/doc/r3.3.3/recipes.html" target="_blank" rel="noopener noreferrer">Link 2</a> <a href="https://zookeeper.apache.org/doc/r3.1.2/zookeeperProgrammers.html" target="_blank" rel="noopener noreferrer">Link 3</a>
</li>
  <li><a href="https://www.elastic.co/blog/found-zookeeper-king-of-coordination" target="_blank" rel="noopener noreferrer">Elastic Search</a></li>
  <li><a href="https://distributedalgorithm.wordpress.com/tag/zookeeper/#:~:text=leader%20and%20followers%2D%20in%20ZooKeeper,between%20all%20followers%20and%20leader." target="_blank" rel="noopener noreferrer">ZAB</a></li>
  <li><a href="/assets/img/zk/zookeeper.pdf">Zookeeper Paper</a></li>
</ol>

  </article>

  
  <div id="disqus_thread"></div>
  <script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://https-pratyusv-github-io.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" target="_blank" rel="noopener noreferrer">comments powered by Disqus.</a>
</noscript>
  <a href="http://disqus.com" class="dsq-brlink" target="_blank" rel="noopener noreferrer">comments powered by <span class="logo-disqus">Disqus</span></a>
  
</div>

    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        © Copyright 2024 Pratyush  Varshney. Powered by <a href="http://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>.

      </div>
    </footer>
  </body>

  <!-- jQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>

  <!-- Bootsrap & MDB scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  <!-- Mansory & imagesLoaded -->
  <script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
  <script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/mansory.js" type="text/javascript"></script>
  
  <!-- Medium Zoom JS -->
  <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
  <script src="/assets/js/zoom.js"></script><!-- Load Common JS -->
  <script src="/assets/js/common.js"></script>

  <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id="></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', '');
  </script>
</html>

